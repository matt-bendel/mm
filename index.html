<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Moonlit Bandanas — Join</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&family=Crimson+Text:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
</head>
<body>
<header>
  <div class="title">Moonlit Bandanas</div>
  <div class="subtitle">Join • Your Character • Live Play</div>
  <div class="navlinks" id="topLinks"><a href="./create.html">Create</a> · <a href="./admin.html">Admin</a></div>
</header>

<div class="wrap">
  <!-- JOIN -->
  <section id="panel-join" class="panel">
    <div class="grid">
      <div><label>Room Code</label><input id="joinRoom" placeholder="Enter room code exactly" /></div>
      <div><label>Room Password</label><input id="joinPass" type="password" placeholder="Enter the room password" /></div>
      <div><label>Your Real Name</label><input id="realName" placeholder="e.g., Alex Johnson" /></div>
      <div class="row">
        <button class="btn" id="assignBtn">Get My Character</button>
        <button class="btn secondary" id="revealMineBtn">Reveal Mine Again</button>
      </div>
      <div id="assignStatus" class="muted"></div>
    </div>
  </section>

  <!-- ACTIVE -->
  <section id="panel-active" class="panel" hidden>
    <div class="grid">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:12px">
          <span class="pill" id="activeRoomPill">Room: —</span>
          <span class="pill" id="activeNamePill">Player: —</span>
          <span class="pill" id="roundPill">Round: —</span>
          <span class="pill" id="voteStatusPill">Vote: —</span>
          <span class="pill" id="voteCountdownPill">⏳ —</span>
        </div>
        <button class="btn secondary" id="refreshActiveBtn">Refresh</button>
      </div>

      <div class="divider"></div>

      <div class="card" id="charSummaryBox">
        <h3 class="kicker" id="charHeader">Your Character</h3>
        <div id="charSummaryText" class="muted">—</div>
        <div id="roleDetailsBox" style="margin-top:10px"></div>
      </div>

      <!-- Revealed clues are visible in both waiting & live (unless dead) -->
      <div class="card" id="cluesBlock">
        <h3 class="kicker">Revealed Clues</h3>
        <div id="cluesList" class="grid" style="gap:14px"></div>
      </div>

      <!-- Waiting state -->
      <div id="waitingState" class="card">
        <h3 class="kicker">Waiting for Host to Start</h3>
        <div class="muted">You’ll see objectives, notes, and Mob Justice once the game begins.</div>
      </div>

      <!-- Live game block -->
      <div id="liveGameBlock" hidden>
        <div class="grid grid-2">
          <div>
            <h3 class="kicker">Your Objectives</h3>
            <div id="todoList" class="muted">—</div>
          </div>
          <div>
            <h3 class="kicker">Notes (private)</h3>
            <textarea id="notesBox" placeholder="Jot suspects, alibis, or reminders… (saved on this device)"></textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn secondary" id="saveNotesBtn">Save Notes</button>
              <span class="muted">Notes are not uploaded.</span>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <h3 class="kicker">Mob Justice</h3>
          <div id="voteBlock">
            <div class="muted" id="voteHelp">Waiting for Admin to open voting…</div>
            <div id="candidateList" class="vote-list" style="margin-top:8px"></div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="castVoteBtn">Cast / Update Vote</button>
              <span class="muted">One vote per round; you can change it until voting closes.</span>
            </div>
            <div class="divider"></div>
            <div id="tallyBox" class="muted"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<dialog id="resultModal">
  <div class="modal-head" id="modalTitle">Result</div>
  <div class="modal-body" id="modalBody"></div>
  <div class="modal-actions"><button class="btn secondary" id="closeModalBtn">Close</button></div>
</dialog>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="./app.js"></script>
<script>
MB.initFirebase();
const db = MB.getDB();
const {$, setCookie, getCookie, uid, verifyRoomPassword, claimCharacter,
       renderRoleDetails, bindModal, storage} = MB;
const store = storage || {get:()=>"", set:()=>{}, remove:()=>{}, clear:()=>{}};
const {popup} = bindModal('closeModalBtn');

// Helper: base character name (strip biography regardless of dash variant)
function baseCharName(s){
  const val = (s||'').trim();
  const seps = [' — ', ' - ', ' �?" '];
  for (const sep of seps){
    const ix = val.indexOf(sep);
    if (ix !== -1) return val.slice(0, ix).trim();
  }
  return val;
}

// Prefill from cookies
(function(){
  const r = getCookie('mb_room'), n = getCookie('mb_name');
  if (r) $('joinRoom').value = r;
  if (n) $('realName').value = n;
})();

function saveLocal(room,name,charId,charName){
  store.set('mb_room', room);
  store.set('mb_name', name);
  store.set('mb_charId', charId);
  store.set('mb_charName', charName);
  setCookie('mb_room', room, 30);
  setCookie('mb_name', name, 30);
}

function hideTopLinksAfterJoin(joined){
  const nav = $('topLinks');
  if (nav){
    nav.hidden = !!joined;
    nav.style.display = joined ? 'none' : '';
  }
}

const activeSession = {
  room: '',
  name: '',
  charId: '',
  charName: '',
  uid: '',
  subscribedRoom: '',
  subscribedUid: '',
  listeners: [],
  data: { state: null, users: null, characters: null, clues: null }
};

function resetActiveData(){
  activeSession.data.state = null;
  activeSession.data.users = null;
  activeSession.data.characters = null;
  activeSession.data.clues = null;
}

function detachActiveListeners(){
  activeSession.listeners.forEach(({ref, handler})=> ref.off('value', handler));
  activeSession.listeners.length = 0;
  activeSession.subscribedRoom = '';
  activeSession.subscribedUid = '';
  resetActiveData();
}

function ensureActiveSubscriptions(room, uidVal){
  if (!room || !uidVal){
    detachActiveListeners();
    return;
  }
  if (activeSession.subscribedRoom === room && activeSession.subscribedUid === uidVal){
    return;
  }

  detachActiveListeners();
  activeSession.subscribedRoom = room;
  activeSession.subscribedUid = uidVal;

  const addListener = (path, key)=>{
    const ref = db.ref(path);
    const handler = snap=>{
      const val = snap.exists()? snap.val() : null;
      if (key === 'state') activeSession.data.state = val || {};
      else if (key === 'users') activeSession.data.users = val || {};
      else if (key === 'characters') activeSession.data.characters = val || {};
      else if (key === 'clues') activeSession.data.clues = val || {};
      renderActiveWithData();
    };
    ref.on('value', handler);
    activeSession.listeners.push({ref, handler});
  };

  addListener(`rooms/${room}/state`, 'state');
  addListener(`rooms/${room}/users`, 'users');
  addListener(`rooms/${room}/characters`, 'characters');
  addListener(`rooms/${room}/clues`, 'clues');
}

$('assignBtn').onclick = async ()=>{
  const room = ($('joinRoom').value||'').trim().toUpperCase();
  const pass = ($('joinPass').value||'').trim();
  const name = ($('realName').value||'').trim();
  const status = $('assignStatus');
  if (!room || !pass || !name){ status.textContent='Enter room, password, and name.'; return; }
  status.textContent='Assigning...';
  try{
    const pick = await claimCharacter(room, pass, name);
    saveLocal(room, name, pick.id, pick.name);
    status.textContent='Assigned.';
    $('panel-join').hidden = true;
    $('panel-active').hidden = false;
    hideTopLinksAfterJoin(true);
    await refreshActive();
  }catch(e){ status.textContent = 'Error: '+e.message; }
};

$('revealMineBtn').onclick = async ()=>{
  const room = ($('joinRoom').value||'').trim().toUpperCase();
  const pass = ($('joinPass').value||'').trim();
  const name = ($('realName').value||'').trim();
  const status = $('assignStatus');
  if (!room || !pass || !name){ status.textContent='Enter room, password, and name.'; return; }
  try{
    const ok = await verifyRoomPassword(room, pass);
    if (!ok) throw new Error('Incorrect password');
    const myUid = uid(room, name);
    const uSnap = await db.ref(`rooms/${room}/users/${myUid}`).get();
    if (!uSnap.exists()){ status.textContent='No prior assignment.'; return; }
    const {charId} = uSnap.val();
    const rSnap = await db.ref(`rooms/${room}/characters/${charId}`).get();
    const charName = rSnap.exists()? rSnap.val().name : '(unknown)';
    saveLocal(room, name, charId, charName);
    $('panel-join').hidden = true;
    $('panel-active').hidden = false;
    hideTopLinksAfterJoin(true);
    await refreshActive();
  }catch(e){ status.textContent = 'Error: '+e.message; }
};

$('saveNotesBtn').onclick = ()=>{
  const room = store.get('mb_room'); const name = store.get('mb_name');
  if (!room || !name){ alert('Join first.'); return; }
  store.set(`mb_notes_${room}_${name}`, $('notesBox').value);
  alert('Notes saved.');
};

$('refreshActiveBtn').onclick = refreshActive;

async function refreshActive(){
  const room = store.get('mb_room') || '';
  const name = store.get('mb_name') || '';
  const charId = store.get('mb_charId') || '';
  const charName = store.get('mb_charName') || '';

  const joined = !!charId;
  hideTopLinksAfterJoin(joined);

  activeSession.room = room;
  activeSession.name = name;
  activeSession.charId = charId;
  activeSession.charName = charName;
  activeSession.uid = joined && room && name ? uid(room, name) : '';

  if (!joined){
    detachActiveListeners();
    $('panel-join').hidden = false;
    $('panel-active').hidden = true;
    return;
  }

  $('panel-join').hidden = true;
  $('panel-active').hidden = false;

  ensureActiveSubscriptions(room, activeSession.uid);
  await renderActiveWithData();
}

async function renderActiveWithData(){
  const {room, name, uid: myUid, charId, charName} = activeSession;
  if (!room || !name || !myUid) return;

  const state = activeSession.data.state || {};
  const voting = state.voting || {};
  const users = activeSession.data.users || {};
  const chars = activeSession.data.characters || {};
  const clues = activeSession.data.clues || {};
  const me = users ? users[myUid] : null;
  const charRec = (me && me.charId && chars[me.charId]) || (charId && chars[charId]) || null;
  const charLine = baseCharName(charRec ? charRec.name : (charName||'—'));
  const bio = (charRec && (charRec.bio || charRec.desc)) || '';

  $('activeRoomPill').textContent = `Room: ${room||'—'}`;
  $('activeNamePill').textContent = `Player: ${name||'—'}`;
  $('roundPill').textContent = `Round: ${state.round||1}`;
  $('voteStatusPill').textContent = `Vote: ${voting.open ? 'OPEN' : (voting.closed ? 'CLOSED' : '—')}`;
  MB.updateCountdownPill($('voteCountdownPill'), voting.endsAt);

  if (!me){
    $('charHeader').textContent = 'Your Character';
    const waitingText = bio ? `<div class="muted">${bio}</div>` : '<div class="muted">Waiting for assignment sync...</div>';
    $('charSummaryText').innerHTML = `<div><b>${charLine}</b></div>${waitingText}`;
    $('roleDetailsBox').innerHTML = '';
    $('waitingState').hidden=false;
    $('liveGameBlock').hidden=true;
    renderClues(clues);
    return;
  }

  const isDead = !!(me.dead || (me.charId && chars[me.charId]?.dead));
  $('charHeader').textContent = `Your Character${isDead ? ' (Dead)' : ''}`;
  $('charSummaryText').innerHTML = `<div><b>${charLine}</b></div>${bio ? `<div class="muted" style="margin-top:6px">${bio}</div>` : ''}`;
  $('roleDetailsBox').innerHTML = MB.renderRoleDetails(me, users, chars);

  if (isDead){
    $('waitingState').hidden = true;
    $('liveGameBlock').hidden = true;
    $('cluesBlock').hidden = true;
    return;
  }

  $('cluesBlock').hidden = false;
  renderClues(clues);

  if (!state.gameStarted){
    $('waitingState').hidden=true;
    $('liveGameBlock').hidden=true;
    return;
  }

  $('waitingState').hidden=true;
  $('liveGameBlock').hidden=false;

  const toShow = Math.min(me.tasks?.length||0, state.round||1);
  const tasks = (me.tasks||[]).slice(0, toShow);
  $('todoList').innerHTML = tasks.map((t,i)=>`
    <label class="todo ${t.done?'done':''}">
      <input type="checkbox" data-ix="${i}" ${t.done?'checked':''}/>
      <div>${t.text}</div>
    </label>`).join('') || '<div class="muted">No tasks.</div>';
  [...$('todoList').querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
    cb.addEventListener('change', async (e)=>{
      const ix = Number(e.target.getAttribute('data-ix'));
      await db.ref(`rooms/${room}/users/${myUid}/tasks/${ix}/done`).set(e.target.checked);
    });
  });

  $('notesBox').value = store.get(`mb_notes_${room}_${name}`)||'';
  renderPlayerVoting(room, myUid, state, users, chars);
}

function renderClues(clues){
  const box = $('cluesList'); box.innerHTML='';
  const revealed = Object.entries(clues||{}).filter(([id,c])=> c && c.revealed);
  if (!revealed.length){ box.innerHTML = '<div class="muted">No clues revealed yet.</div>'; return; }
  revealed.forEach(([id,c])=>{
    const el = document.createElement('article');
    el.className = 'parchment';
    el.innerHTML = `<div class="tag">Clue ${id}</div><h4>${c.title||'(untitled)'}</h4><div>${c.body||''}</div>`;
    box.appendChild(el);
  });
}

function renderPlayerVoting(room, uidVal, state, users, chars){
  const help = $('voteHelp'), list = $('candidateList'), tallyBox = $('tallyBox'), btn = $('castVoteBtn');
  const voting = state.voting || {};
  MB.updateCountdownPill($('voteCountdownPill'), voting.endsAt);

  if (!voting.open && !voting.closed){
    help.textContent='Waiting for Admin to open voting...';
    list.innerHTML=''; tallyBox.innerHTML=''; btn.disabled=true; return;
  }

  const candidates = voting.candidates || {};
  const votes = voting.votes || {};
  const items = Object.keys(candidates);

  const display = items.map(k=>{
    const u = users[k];
    let charName = '';
    if (u && u.charId && chars[u.charId]) charName = baseCharName(chars[u.charId].name);
    const dead = u?.dead || (u?.charId && chars[u.charId]?.dead);
    const label = u ? `${u.name}${charName? ' — '+charName:''}${dead?' (dead)':''}` : k;
    return {key:k, label, dead: !!dead};
  });

  const myVote = votes[uidVal] || '';
  const youAreCandidate = !!candidates[uidVal];

  if (voting.open){
    help.textContent = 'Voting is OPEN. Choose one candidate.' + (youAreCandidate ? ' (You are also a candidate.)' : '');
    list.innerHTML = display.map(d=>`
      <label class="vote-item">
        <input type="radio" name="voteChoice" value="${d.key}" ${myVote===d.key?'checked':''} ${d.dead?'disabled':''}/>
        <div>${d.label}</div>
      </label>`).join('') || '<div class="muted">No candidates yet.</div>';
    btn.disabled=false;
    tallyBox.innerHTML='<span class="muted">Tally will appear when voting closes.</span>';
  }else{
    help.textContent='Voting is CLOSED. Final tally:';
    list.innerHTML = display.map(d=>`<div class="vote-item"><div>${d.label}</div></div>`).join('') || '<div class="muted">No candidates.</div>';
    btn.disabled=true;

    const tally = MB.computeTally(users, chars, votes);
    const tallyLines = display.map(d=>`- ${d.label}: <b class="tally">${tally[d.key]||0}</b>`).join('<br>');
    tallyBox.innerHTML = tallyLines || 'No votes.';
  }
}

$('castVoteBtn').onclick = async ()=>{
  const room = store.get('mb_room'); const name = store.get('mb_name');
  if (!room || !name) return;
  const myUid = MB.uid(room,name);
  const stateSnap = await db.ref(`rooms/${room}/state`).get();
  const state = stateSnap.exists()? stateSnap.val() : {};
  if (!state.voting?.open){ alert('Voting is not open.'); return; }

  const choice = document.querySelector('input[name="voteChoice"]:checked');
  if (!choice){ alert('Pick a candidate.'); return; }
  await db.ref(`rooms/${room}/state/voting/votes/${myUid}`).set(choice.value);
  alert('Vote recorded.');
};

// Initial render
document.addEventListener('DOMContentLoaded', ()=> refreshActive());
</script>
</body>
</html>


