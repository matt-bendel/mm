<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Moonlit Bandanas — Join</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&family=Crimson+Text:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
</head>
<body>
<header>
  <div class="title">Moonlit Bandanas</div>
  <div class="subtitle">Join • Your Character • Live Play</div>
  <div class="navlinks" id="topLinks"><a href="./create.html">Create</a> · <a href="./admin.html">Admin</a></div>
</header>

<div class="wrap">
  <!-- JOIN -->
  <section id="panel-join" class="panel">
    <div class="grid">
      <div><label>Room Code</label><input id="joinRoom" placeholder="Enter room code exactly" /></div>
      <div><label>Room Password</label><input id="joinPass" type="password" placeholder="Enter the room password" /></div>
      <div><label>Your Real Name</label><input id="realName" placeholder="e.g., Alex Johnson" /></div>
      <div class="row">
        <button class="btn" id="assignBtn">Get My Character</button>
        <button class="btn secondary" id="revealMineBtn">Reveal Mine Again</button>
      </div>
      <div id="assignStatus" class="muted"></div>
    </div>
  </section>

  <!-- ACTIVE -->
  <section id="panel-active" class="panel" hidden>
    <div class="grid">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:12px">
          <span class="pill" id="activeRoomPill">Room: —</span>
          <span class="pill" id="activeNamePill">Player: —</span>
          <span class="pill" id="roundPill">Round: —</span>
          <span class="pill" id="voteStatusPill">Vote: —</span>
          <span class="pill" id="voteCountdownPill">⏳ —</span>
        </div>
        <button class="btn secondary" id="refreshActiveBtn">Refresh</button>
      </div>

      <div class="divider"></div>

      <div class="card" id="charSummaryBox">
        <h3 class="kicker" id="charHeader">Your Character</h3>
        <div id="charSummaryText" class="muted">—</div>
        <div id="roleDetailsBox" style="margin-top:10px"></div>
      </div>

      <!-- Revealed clues are visible in both waiting & live (unless dead) -->
      <div class="card" id="cluesBlock">
        <h3 class="kicker">Revealed Clues</h3>
        <div id="cluesList" class="grid" style="gap:14px"></div>
      </div>

      <!-- Waiting state -->
      <div id="waitingState" class="card">
        <h3 class="kicker">Waiting for Host to Start</h3>
        <div class="muted">You’ll see objectives, notes, and Mob Justice once the game begins.</div>
      </div>

      <!-- Live game block -->
      <div id="liveGameBlock" hidden>
        <div class="grid grid-2">
          <div>
            <h3 class="kicker">Your Objectives</h3>
            <div id="todoList" class="muted">—</div>
          </div>
          <div>
            <h3 class="kicker">Notes (private)</h3>
            <textarea id="notesBox" placeholder="Jot suspects, alibis, or reminders… (saved on this device)"></textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn secondary" id="saveNotesBtn">Save Notes</button>
              <span class="muted">Notes are not uploaded.</span>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <h3 class="kicker">Mob Justice</h3>
          <div id="voteBlock">
            <div class="muted" id="voteHelp">Waiting for Admin to open voting…</div>
            <div id="candidateList" class="vote-list" style="margin-top:8px"></div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="castVoteBtn">Cast / Update Vote</button>
              <span class="muted">One vote per round; you can change it until voting closes.</span>
            </div>
            <div class="divider"></div>
            <div id="tallyBox" class="muted"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<dialog id="resultModal">
  <div class="modal-head" id="modalTitle">Result</div>
  <div class="modal-body" id="modalBody"></div>
  <div class="modal-actions"><button class="btn secondary" id="closeModalBtn">Close</button></div>
</dialog>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="./app.js"></script>
<script>
MB.initFirebase();
const db = MB.getDB();
const {$, setCookie, getCookie, uid, verifyRoomPassword, claimCharacter,
       renderRoleDetails, bindModal} = MB;
const {popup} = bindModal('closeModalBtn');

// Helper: base character name (strip " — biography")
function baseCharName(s){ return (s||'').split(' — ')[0].trim(); }

// Prefill from cookies
(function(){
  const r = getCookie('mb_room'), n = getCookie('mb_name');
  if (r) $('joinRoom').value = r;
  if (n) $('realName').value = n;
})();

function saveLocal(room,name,charId,charName){
  localStorage.setItem('mb_room', room);
  localStorage.setItem('mb_name', name);
  localStorage.setItem('mb_charId', charId);
  localStorage.setItem('mb_charName', charName);
  setCookie('mb_room', room, 30);
  setCookie('mb_name', name, 30);
}

function hideTopLinksAfterJoin(joined){
  const nav = $('topLinks');
  if (nav) nav.hidden = !!joined;
}

$('assignBtn').onclick = async ()=>{
  const room = ($('joinRoom').value||'').trim().toUpperCase();
  const pass = ($('joinPass').value||'').trim();
  const name = ($('realName').value||'').trim();
  const status = $('assignStatus');
  if (!room || !pass || !name){ status.textContent='Enter room, password, and name.'; return; }
  status.textContent='Assigning…';
  try{
    const pick = await claimCharacter(room, pass, name);
    saveLocal(room, name, pick.id, pick.name);
    status.textContent='Assigned.';
    $('panel-join').hidden = true;
    $('panel-active').hidden = false;
    hideTopLinksAfterJoin(true);
    await refreshActive();
  }catch(e){ status.textContent = 'Error: '+e.message; }
};

$('revealMineBtn').onclick = async ()=>{
  const room = ($('joinRoom').value||'').trim().toUpperCase();
  const pass = ($('joinPass').value||'').trim();
  const name = ($('realName').value||'').trim();
  const status = $('assignStatus');
  if (!room || !pass || !name){ status.textContent='Enter room, password, and name.'; return; }
  try{
    const ok = await verifyRoomPassword(room, pass);
    if (!ok) throw new Error('Incorrect password');
    const myUid = uid(room, name);
    const uSnap = await db.ref(`rooms/${room}/users/${myUid}`).get();
    if (!uSnap.exists()){ status.textContent='No prior assignment.'; return; }
    const {charId} = uSnap.val();
    const rSnap = await db.ref(`rooms/${room}/characters/${charId}`).get();
    const charName = rSnap.exists()? rSnap.val().name : '(unknown)';
    saveLocal(room, name, charId, charName);
    $('panel-join').hidden = true;
    $('panel-active').hidden = false;
    hideTopLinksAfterJoin(true);
    await refreshActive();
  }catch(e){ status.textContent = 'Error: '+e.message; }
};

$('saveNotesBtn').onclick = ()=>{
  const room = localStorage.getItem('mb_room'); const name = localStorage.getItem('mb_name');
  if (!room || !name){ alert('Join first.'); return; }
  localStorage.setItem(`mb_notes_${room}_${name}`, $('notesBox').value);
  alert('Notes saved.');
};

$('refreshActiveBtn').onclick = refreshActive;

async function refreshActive(){
  const room = localStorage.getItem('mb_room') || '';
  const name = localStorage.getItem('mb_name') || '';
  const charId = localStorage.getItem('mb_charId') || '';
  const charName = localStorage.getItem('mb_charName') || '';

  const joined = !!charId;
  hideTopLinksAfterJoin(joined);

  if (!joined){
    $('panel-join').hidden = false;
    $('panel-active').hidden = true;
    return;
  }

  $('panel-join').hidden = true;
  $('panel-active').hidden = false;

  $('activeRoomPill').textContent = `Room: ${room||'—'}`;
  $('activeNamePill').textContent = `Player: ${name||'—'}`;

  const myUid = uid(room, name);
  const [userSnap, stateSnap, charsSnap, usersSnap, cluesSnap] = await Promise.all([
    db.ref(`rooms/${room}/users/${myUid}`).get(),
    db.ref(`rooms/${room}/state`).get(),
    db.ref(`rooms/${room}/characters`).get(),
    db.ref(`rooms/${room}/users`).get(),
    db.ref(`rooms/${room}/clues`).get()
  ]);
  const state = stateSnap.exists()? stateSnap.val(): {gameStarted:false, round:1, voting:{}};
  const voting = state.voting || {};
  const chars = charsSnap.exists()? charsSnap.val(): {};
  const users = usersSnap.exists()? usersSnap.val(): {};
  const clues = cluesSnap.exists()? cluesSnap.val(): {};

  $('roundPill').textContent = `Round: ${state.round||1}`;
  $('voteStatusPill').textContent = `Vote: ${voting.open ? 'OPEN' : (voting.closed ? 'CLOSED' : '—')}`;
  MB.updateCountdownPill($('voteCountdownPill'), voting.endsAt);

  if (!userSnap.exists()){
    $('charSummaryText').innerHTML='—';
    $('roleDetailsBox').innerHTML='';
    $('waitingState').hidden=false;
    $('liveGameBlock').hidden=true;
    await renderClues(clues); // still show revealed clues, even if user doc missing
    return;
  }

  const me = userSnap.val();
  const charRec = me.charId && chars[me.charId] ? chars[me.charId] : null;
  const charLine = baseCharName(charRec ? charRec.name : (charName||'—'));

  // Dead check: if dead, mark header and hide everything below
  const isDead = !!(me.dead || (me.charId && chars[me.charId]?.dead));
  $('charHeader').textContent = `Your Character${isDead ? ' (Dead)' : ''}`;
  $('charSummaryText').innerHTML = `<div><b>${charLine}</b></div>`;
  $('roleDetailsBox').innerHTML = MB.renderRoleDetails(me, users, chars);

  if (isDead){
    // Hide everything below the character card
    $('waitingState').hidden = true;
    $('liveGameBlock').hidden = true;
    $('cluesBlock').hidden = true;
    return;
  }else{
    // Show clues (revealed) always if alive
    $('cluesBlock').hidden = false;
    await renderClues(clues);
  }

  if (!state.gameStarted){
    $('waitingState').hidden=true; // we still show clues; hide objectives/vote
    $('liveGameBlock').hidden=true;
  }else{
    $('waitingState').hidden=true;
    $('liveGameBlock').hidden=false;

    // Show up to current round tasks
    const toShow = Math.min(me.tasks?.length||0, state.round||1);
    const tasks = (me.tasks||[]).slice(0, toShow);
    $('todoList').innerHTML = tasks.map((t,i)=>`
      <label class="todo ${t.done?'done':''}">
        <input type="checkbox" data-ix="${i}" ${t.done?'checked':''}/>
        <div>${t.text}</div>
      </label>`).join('') || '<div class="muted">No tasks.</div>';
    [...$('todoList').querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
      cb.addEventListener('change', async (e)=>{
        const ix = Number(e.target.getAttribute('data-ix'));
        await db.ref(`rooms/${room}/users/${myUid}/tasks/${ix}/done`).set(e.target.checked);
        refreshActive();
      });
    });

    // Notes load
    $('notesBox').value = localStorage.getItem(`mb_notes_${room}_${name}`)||'';

    // Voting
    await renderPlayerVoting(room, myUid, state, users, chars);
  }
}

async function renderClues(clues){
  const box = $('cluesList'); box.innerHTML='';
  const revealed = Object.entries(clues||{}).filter(([id,c])=> c && c.revealed);
  if (!revealed.length){ box.innerHTML = '<div class="muted">No clues revealed yet.</div>'; return; }
  revealed.forEach(([id,c])=>{
    const el = document.createElement('article');
    el.className = 'parchment';
    el.innerHTML = `<div class="tag">Clue ${id}</div><h4>${c.title||'(untitled)'}</h4><div>${c.body||''}</div>`;
    box.appendChild(el);
  });
}

async function renderPlayerVoting(room, uidVal, state, users, chars){
  const help = $('voteHelp'), list = $('candidateList'), tallyBox = $('tallyBox'), btn = $('castVoteBtn');
  const voting = state.voting || {};
  MB.updateCountdownPill($('voteCountdownPill'), voting.endsAt);

  if (!voting.open && !voting.closed){
    help.textContent='Waiting for Admin to open voting…';
    list.innerHTML=''; tallyBox.innerHTML=''; btn.disabled=true; return;
  }

  const candidates = voting.candidates || {};
  const votes = voting.votes || {};
  const items = Object.keys(candidates);
  const nominated = !!candidates[uidVal]; // nominated players cannot vote

  // Build candidate display (Real Name + Character Name only)
  const display = items.map(k=>{
    const u = users[k];
    let charName = '';
    if (u && u.charId && chars[u.charId]) charName = baseCharName(chars[u.charId].name);
    const dead = u?.dead || (u?.charId && chars[u.charId]?.dead);
    const label = u ? `${u.name}${charName? ' — '+charName:''}${dead?' (dead)':''}` : k;
    return {key:k, label, dead: !!dead};
  });

  const myVote = votes[uidVal] || '';

  if (voting.open){
    if (nominated){
      help.textContent='Voting is OPEN. You are a current candidate and cannot vote.';
      list.innerHTML = display.map(d=>`
        <label class="vote-item">
          <input type="radio" name="voteChoice" value="${d.key}" disabled/>
          <div>${d.label}</div>
        </label>`).join('') || '<div class="muted">No candidates yet.</div>';
      btn.disabled = true;
      tallyBox.innerHTML='<span class="muted">Tally will appear when voting closes.</span>';
      return;
    }

    help.textContent='Voting is OPEN. Choose one candidate:';
    list.innerHTML = display.map(d=>`
      <label class="vote-item">
        <input type="radio" name="voteChoice" value="${d.key}" ${myVote===d.key?'checked':''} ${d.dead?'disabled':''}/>
        <div>${d.label}</div>
      </label>`).join('') || '<div class="muted">No candidates yet.</div>';
    btn.disabled=false;
    tallyBox.innerHTML='<span class="muted">Tally will appear when voting closes.</span>';
  }else{
    help.textContent='Voting is CLOSED. Final tally:';
    list.innerHTML = display.map(d=>`<div class="vote-item"><div>${d.label}</div></div>`).join('') || '<div class="muted">No candidates.</div>';
    btn.disabled=true;

    const tally = MB.computeTally(users, chars, votes);
    const tallyLines = display.map(d=>`• ${d.label}: <b class="tally">${tally[d.key]||0}</b>`).join('<br>');
    tallyBox.innerHTML = tallyLines || 'No votes.';
  }
}

$('castVoteBtn').onclick = async ()=>{
  const room = localStorage.getItem('mb_room'); const name = localStorage.getItem('mb_name');
  if (!room || !name) return;
  const myUid = MB.uid(room,name);
  const stateSnap = await db.ref(`rooms/${room}/state`).get();
  const state = stateSnap.exists()? stateSnap.val() : {};
  if (!state.voting?.open){ alert('Voting is not open.'); return; }
  if (state.voting?.candidates && state.voting.candidates[myUid]){
    alert('You are nominated and cannot vote this round.');
    return;
  }
  const choice = document.querySelector('input[name="voteChoice"]:checked');
  if (!choice){ alert('Pick a candidate.'); return; }
  await db.ref(`rooms/${room}/state/voting/votes/${myUid}`).set(choice.value);
  alert('Vote recorded.');
  await refreshActive();
};

// Initial render
document.addEventListener('DOMContentLoaded', ()=> refreshActive());
</script>
</body>
</html>
